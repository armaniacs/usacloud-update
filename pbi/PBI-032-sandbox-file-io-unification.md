# PBI-032: サンドボックスファイルI/O処理の統一

## ユーザーストーリー
開発者として、サンドボックス機能のファイル処理コードを統一したい、なぜなら既存のファイルI/Oユーティリティが活用されずに重複コードが残っているから

## ビジネス価値
- **保守性向上**: ファイル処理ロジックの一元管理により、バグ修正・機能追加の影響範囲を限定
- **開発効率**: 統一されたAPIによる新機能開発の高速化（推定30%短縮）
- **品質向上**: 既にテスト済みのファイルI/Oライブラリ活用による信頼性確保

## BDD受け入れシナリオ

```gherkin
Scenario: サンドボックスモードでのファイル読み込み統一
  Given サンドボックス用のスクリプトファイル"test.sh"が存在する
  When ユーザーが"usacloud-update --sandbox --in test.sh"を実行する
  Then ファイルが統一されたI/Oライブラリで読み込まれる
  And バイナリファイルチェックが正常に動作する
  And エラーハンドリングが一貫している

Scenario: 複数ファイル処理の統一
  Given 複数のスクリプトファイルが選択される
  When サンドボックスモードで処理される
  Then 全てのファイルが統一されたI/Oライブラリで読み込まれる
  And メモリ効率的に処理される（1MBバッファ）

Scenario: エラーハンドリングの統一性確認
  Given 存在しないファイルが指定される
  When サンドボックスモードで実行される
  Then 統一されたエラーフォーマッターでエラーが表示される
  And メインCLIと同じエラーメッセージ形式になる
```

## 受け入れ基準
- [ ] `runSandboxMode`関数が`internal/cli/io`パッケージを使用している
- [ ] 重複するbufio.Scannerコードが除去されている（推定80行削減）
- [ ] `readFileLines`関数が`cliio.ReadFileLines`を使用している
- [ ] バイナリファイル検出が統一されている
- [ ] エラーメッセージが既存のErrorFormatterを使用している
- [ ] 既存のサンドボックステストが全て通る
- [ ] ファイル処理性能が維持または改善されている

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- サンドボックスモードでのファイル読み込み正常動作
- 複数ファイル処理の動作確認
- エラーケースの動作確認

統合テスト:
- ファイルI/Oライブラリとサンドボックス機能の連携
- エラーフォーマッターとの統合

単体テスト:
- リファクタリング前後の動作同等性確認
- ファイル読み込み処理の境界値テスト
```

## 実装アプローチ
- **Outside-In**: 既存のE2Eテストを保持しながらリファクタリング
- **Red-Green-Refactor**: テスト→リファクタリング→テスト確認のサイクル
- **段階的移行**: 一つずつ重複箇所を置き換え

## 見積もり
2ストーリーポイント（1-2日）

## 技術的考慮事項
- **依存関係**: 既存の`internal/cli/io`パッケージに依存
- **テスタビリティ**: 既存テストスイートによる回帰テスト
- **パフォーマンス**: 1MBバッファサイズの維持
- **後方互換性**: APIの変更なし

## Definition of Done
- [ ] 受け入れシナリオが全て通る
- [ ] 既存の全テストが通る（`make test`）
- [ ] コードレビュー完了
- [ ] 重複コードが除去されている
- [ ] パフォーマンステスト通過
- [ ] リファクタリング完了（機能変更なし）

## 実装詳細
1. `runSandboxMode`内のファイル読み込み箇所を特定
2. `cliio.ReadFileLines`への置き換え
3. `readFileLines`関数の簡素化
4. エラーハンドリングの統一
5. テスト実行で動作確認

## 影響範囲
- **ファイル**: `cmd/usacloud-update/main.go` (runSandboxMode関数)
- **削減コード**: 約80行の重複スキャナーロジック
- **テスト**: 既存サンドボックステストで検証

## 関連PBI
- PBI-030: ファイルI/Oユーティリティ（基盤として利用）
- PBI-029: エラーメッセージフォーマット（エラー処理で利用）