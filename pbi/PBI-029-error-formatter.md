# PBI-029: エラーメッセージフォーマットの統一

## ユーザーストーリー
開発者として、エラーメッセージのフォーマットを統一したい、なぜなら一貫性のあるエラー体験を提供し、国際化対応を容易にしたいから

## ビジネス価値
- **ユーザー体験向上**: 一貫したエラーメッセージによる直感的な理解
- **国際化対応**: 将来の多言語サポートの基盤構築
- **保守性向上**: エラーメッセージ変更時の一元管理

## BDD受け入れシナリオ

```gherkin
Scenario: ファイル読み込みエラーの統一表示
  Given 存在しないファイルパス"non_existent.sh"
  When ユーザーが"usacloud-update --in non_existent.sh"を実行する
  Then 統一されたフォーマットでエラーが表示される
  And エラーメッセージが日本語で表示される
  And エラーアイコン「❌」が含まれている

Scenario: 権限エラーの統一表示
  Given 読み取り権限のないファイル"protected.sh"
  When ユーザーが"usacloud-update --in protected.sh"を実行する
  Then "ファイル読み込み失敗: 権限が不足しています"エラーが表示される
  And ファイルパスが含まれている

Scenario: バイナリファイルエラーの統一表示
  Given バイナリファイル"binary.dat"が存在する
  When ユーザーが"usacloud-update --in binary.dat"を実行する
  Then "バイナリファイルは処理できません"エラーが表示される
  And 処理が中断される
```

## 受け入れ基準
- [ ] `internal/cli/errors/formatter.go`パッケージが作成されている
- [ ] `ErrorType`列挙型が定義されている
- [ ] `FormatError(errorType ErrorType, message string, details ...string) string`関数が実装されている
- [ ] ファイル関連エラー、バイナリファイルエラー、権限エラーに対応
- [ ] 既存のエラーメッセージ箇所が統一フォーマットに置き換えられている
- [ ] エラーメッセージが日本語で表示される
- [ ] 既存のテストが全て通る

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- 各種エラー条件でのCLI実行テスト
- エラーメッセージフォーマット検証

統合テスト:
- エラーフォーマッター呼び出しテスト
- 言語設定によるメッセージ切り替えテスト

単体テスト:
- 各ErrorTypeのフォーマットテスト
- メッセージテンプレート挿入テスト
- 特殊文字・改行処理テスト
```

## 実装アプローチ
- **Outside-In**: CLI実行時のエラー表示から開始
- **Red-Green-Refactor**: 既存エラー動作を保持しながら統一
- **テンプレート化**: エラーメッセージのテンプレート管理

## 見積もり
2ストーリーポイント

## 技術的考慮事項
- **依存関係**: fatih/colorパッケージ（カラー出力）
- **テスタビリティ**: エラータイプ別の独立テスト
- **国際化**: 将来のen/ja切り替え対応
- **パフォーマンス**: エラー時のみ使用のため性能影響軽微

## Definition of Done
- [ ] 受け入れシナリオが全て通る
- [ ] 既存テストが全て通る（`make test`）
- [ ] エラーメッセージの内容一貫性が保たれている
- [ ] コードレビュー完了
- [ ] リファクタリング完了（エラー処理統一）
- [ ] ドキュメント更新（エラーメッセージ一覧）

## 実装詳細
1. `internal/cli/errors/`ディレクトリ作成
2. `formatter.go`ファイル作成
3. `ErrorType`列挙型定義
4. エラーメッセージテンプレート定義
5. `FormatError`関数実装
6. 既存のfmt.Errorf箇所を置き換え
7. テスト実行で動作確認

## エラータイプ一覧
- `ErrorFileNotFound`: ファイルが見つからない
- `ErrorFilePermission`: ファイル権限エラー
- `ErrorFileBinary`: バイナリファイル検出
- `ErrorFileRead`: ファイル読み込みエラー
- `ErrorFileWrite`: ファイル書き込みエラー
- `ErrorValidation`: 検証エラー
- `ErrorConfig`: 設定エラー

## 関連PBI
- PBI-028: CLI共通ヘルパーパッケージ
- PBI-030: ファイルI/O処理の共通化