# PBI-024: ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

## æ¦‚è¦
ç¾åœ¨ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œæ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ã—ã€ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã®æä¾›ã¨è‡ªå‹•å›å¾©æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚usacloudã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€èªè¨¼ã‚¨ãƒ©ãƒ¼ãªã©ã®æ§˜ã€…ãªéšœå®³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾ã—ã¦ã€é©åˆ‡ãªå¯¾å‡¦æ–¹æ³•ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æç¤ºã—ã¾ã™ã€‚

## å—ã‘å…¥ã‚Œæ¡ä»¶
- [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼æ™‚ã«æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å¯¾å‡¦æ–¹æ³•ã‚’è¡¨ç¤ºã™ã‚‹
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã«å†å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›ã™ã‚‹
- [ ] èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã«è¨­å®šç¢ºèªã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
- [ ] äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ã‚°å‡ºåŠ›ã¨å•é¡Œå ±å‘Šæ–¹æ³•ã‚’æç¤ºã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒçŠ¶æ…‹ã‚’é©åˆ‡ã«ç®¡ç†ã™ã‚‹

## æŠ€è¡“ä»•æ§˜

### 1. ã‚¨ãƒ©ãƒ¼åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ 
```go
// ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—å®šç¾©
type SandboxErrorType int

const (
    ErrorTypeTimeout SandboxErrorType = iota
    ErrorTypeNetwork
    ErrorTypeAuth
    ErrorTypeCommand
    ErrorTypeUnknown
)

type SandboxError struct {
    Type        SandboxErrorType
    Message     string
    Command     string
    Timestamp   time.Time
    Retryable   bool
    Suggestions []string
}
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…
```go
type ErrorHandler struct {
    logger    *log.Logger
    retryMax  int
    retryWait time.Duration
}

func (h *ErrorHandler) Handle(err error, cmd string) *SandboxError {
    sandboxErr := h.classifyError(err, cmd)
    h.logError(sandboxErr)
    return sandboxErr
}

func (h *ErrorHandler) classifyError(err error, cmd string) *SandboxError {
    // ã‚¨ãƒ©ãƒ¼åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
    if strings.Contains(err.Error(), "timeout") {
        return &SandboxError{
            Type:        ErrorTypeTimeout,
            Message:     "ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ",
            Command:     cmd,
            Timestamp:   time.Now(),
            Retryable:   true,
            Suggestions: []string{"--timeout ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ™‚é–“ã‚’å»¶é•·ã—ã¦ãã ã•ã„", "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„"},
        }
    }
    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼åˆ†é¡
    return nil
}
```

### 3. è‡ªå‹•å›å¾©æ©Ÿèƒ½
```go
type RetryConfig struct {
    MaxAttempts int
    BaseDelay   time.Duration
    MaxDelay    time.Duration
}

func (e *Executor) ExecuteWithRetry(cmd string, config RetryConfig) (*Result, error) {
    for attempt := 1; attempt <= config.MaxAttempts; attempt++ {
        result, err := e.Execute(cmd)
        if err == nil {
            return result, nil
        }
        
        sandboxErr := e.errorHandler.Handle(err, cmd)
        if !sandboxErr.Retryable {
            return nil, err
        }
        
        if attempt < config.MaxAttempts {
            delay := calculateBackoffDelay(attempt, config)
            time.Sleep(delay)
        }
    }
    return nil, fmt.Errorf("æœ€å¤§è©¦è¡Œå›æ•°ã‚’è¶…éã—ã¾ã—ãŸ")
}
```

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: ã‚¨ãƒ©ãƒ¼åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œè¨¼
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: å„ç¨®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®å‹•ä½œç¢ºèª
- **ã‚¨ãƒ©ãƒ¼æ³¨å…¥ãƒ†ã‚¹ãƒˆ**: æ„å›³çš„ã«ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã®æŒ™å‹•ãƒ†ã‚¹ãƒˆ
- **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ†ã‹ã‚Šã‚„ã™ã•æ¤œè¨¼

## ä¾å­˜é–¢ä¿‚
- å‰æPBI: ãªã—ï¼ˆæ—¢å­˜ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ã‚’æ‹¡å¼µï¼‰
- é–¢é€£PBI: PBI-025ï¼ˆä¸¦è¡Œå®Ÿè¡Œã§ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼‰ã€PBI-026ï¼ˆã‚¨ãƒ©ãƒ¼å±¥æ­´ã®æ°¸ç¶šåŒ–ï¼‰
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰: internal/sandbox/executor.go

## è¦‹ç©ã‚‚ã‚Š
- é–‹ç™ºå·¥æ•°: 8æ™‚é–“
  - ã‚¨ãƒ©ãƒ¼åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆãƒ»å®Ÿè£…: 3æ™‚é–“
  - è‡ªå‹•å›å¾©æ©Ÿèƒ½å®Ÿè£…: 3æ™‚é–“
  - ãƒ†ã‚¹ãƒˆå®Ÿè£…: 2æ™‚é–“

## å®Œäº†ã®å®šç¾©
- [ ] å…¨ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ90%ä»¥ä¸Šã«ãªã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ•´å‚™ã•ã‚Œã‚‹

## å®Ÿè£…çŠ¶æ³
âŒ **PBI-024ã¯æœªå®Ÿè£…** (2025-09-11)

**ç¾åœ¨ã®çŠ¶æ³**:
- åŒ…æ‹¬çš„ãªã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ãŒè¨­è¨ˆæ¸ˆã¿
- ã‚¨ãƒ©ãƒ¼åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ ã€è‡ªå‹•å›å¾©ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®è©³ç´°è¨­è¨ˆå®Œäº†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã®ä»•æ§˜ãŒå®Œæˆ
- å®Ÿè£…æº–å‚™ã¯æ•´ã£ã¦ã„ã‚‹ãŒã€ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã¯æœªç€æ‰‹

**å®Ÿè£…ãŒå¿…è¦ãªè¦ç´ **:
- `internal/sandbox/error_handler.go` - åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
- ã‚¨ãƒ©ãƒ¼åˆ†é¡ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆæ©Ÿèƒ½
- è‡ªå‹•å›å¾©ã€ãƒªãƒˆãƒ©ã‚¤ã€ãƒãƒƒã‚¯ã‚ªãƒ•æ©Ÿèƒ½
- ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã¨ã‚¨ãƒ©ãƒ¼æ³¨å…¥ãƒ†ã‚¹ãƒˆ

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åŸºç›¤å®Ÿè£…
2. ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆæ©Ÿèƒ½ã®å®Ÿè£…
3. è‡ªå‹•å›å¾©ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å®Ÿè£…
4. ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Ÿè£…
5. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã¨çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

## å‚™è€ƒ
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã™ã‚‹
- ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¯ã‚¨ãƒ©ãƒ¼ã®é‡è¦åº¦ã«å¿œã˜ã¦é©åˆ‡ã«è¨­å®šã™ã‚‹
- å°†æ¥çš„ã«ã¯ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã¨ã®é€£æºã‚‚è€ƒæ…®ã™ã‚‹

---

## å®Ÿè£…æ–¹é‡å¤‰æ›´ (2025-09-11)

ğŸ”´ **å½“PBIã¯æ©Ÿèƒ½æ‹¡å¼µã®ãŸã‚å®Ÿè£…ã‚’å»¶æœŸã—ã¾ã™**

### å»¶æœŸç†ç”±
- ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ å®‰å®šåŒ–ã‚’å„ªå…ˆ
- æ—¢å­˜æ©Ÿèƒ½ã®ä¿®å¾©ãƒ»æ”¹å–„ãŒæ€¥å‹™
- ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ã‚¢æ©Ÿèƒ½ã®å“è³ªå‘ä¸Šã«é›†ä¸­
- ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½æ‹¡å¼µã‚ˆã‚Šã‚‚æ—¢å­˜ãƒ†ã‚¹ãƒˆã®å®‰å®šåŒ–ãŒç·Šæ€¥

### å†æ¤œè¨æ™‚æœŸ
- v2.0.0å®‰å®šç‰ˆãƒªãƒªãƒ¼ã‚¹å¾Œ
- ãƒ†ã‚¹ãƒˆå®‰å®šåŒ–å®Œäº†å¾Œï¼ˆPBI-024ã€œ030ï¼‰
- åŸºå¹¹æ©Ÿèƒ½ã®å“è³ªç¢ºä¿å®Œäº†å¾Œ
- æ—¢å­˜ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ã®å®‰å®šåŒ–å®Œäº†å¾Œ

### ç¾åœ¨ã®å„ªå…ˆåº¦
**ä½å„ªå…ˆåº¦** - å°†æ¥ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã§å†è©•ä¾¡äºˆå®š

### æ³¨è¨˜
- æ—¢å­˜ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯å¼•ãç¶šãä¿å®ˆãƒ»æ”¹å–„
- æ‹¡å¼µã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…ã¯å»¶æœŸ
- ç¾åœ¨ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŸºç›¤ã®å®‰å®šåŒ–ã‚’æœ€å„ªå…ˆ