# PBI-033: インタラクティブTUIデフォルトモード実装

> ⚠️ **重要**: このPBIはv1.9.6で撤回されました。
> - **撤回理由**: ユーザーフィードバックにより既存ワークフローとの互換性を優先
> - **撤回日**: 2025-09-18
> - **影響**: 引数なしでの実行時、TUIは自動起動せずヘルプが表示されます
> - **関連**: CHANGELOG v1.9.6セクション参照

---

## [以下、元のドキュメント内容 - 歴史的記録として保持]

## ユーザーストーリー
**CLIユーザー**として、**引数なしでusacloud-updateを実行した時に自動でTUIが起動する機能**がほしい、なぜなら**コマンドオプションを覚えずに直感的に操作したい**から

## ビジネス価値
- **学習効率向上**: 初心者の学習時間を50%短縮
- **操作エラー削減**: 視覚的操作による入力ミス防止（推定70%削減）
- **機能発見性向上**: 全機能への視覚的アクセス提供
- **UX向上**: モダンCLIツールのスタンダードに準拠

## BDD受け入れシナリオ

```gherkin
Feature: インタラクティブTUIデフォルトモード
  CLIユーザーとして
  引数なしでusacloud-updateを実行した時に自動でTUIが起動してほしい
  なぜならコマンドオプションを覚えずに直感的に操作したいから

Scenario: 引数なし実行時のTUI自動起動
  Given usacloud-updateコマンドが実行可能である
  And 現在のディレクトリにスクリプトファイルが存在する
  When ユーザーが"usacloud-update"を引数なしで実行する
  Then TUIファイルセレクターが自動的に起動する
  And ファイル一覧が表示される
  And ヘルプパネルが利用可能である

Scenario: 明示的オプション指定時は従来動作維持
  Given usacloud-updateコマンドが実行可能である
  When ユーザーが"usacloud-update --help"を実行する
  Then TUIは起動しない
  And ヘルプメッセージが標準出力に表示される

Scenario: パイプライン入力時は従来動作維持
  Given テキストファイル"input.sh"が存在する
  When ユーザーが"cat input.sh | usacloud-update"を実行する
  Then TUIは起動しない
  And 通常の変換処理が実行される

Scenario: TUI起動失敗時のフォールバック
  Given TUI起動に必要な条件が満たされていない
  When ユーザーが"usacloud-update"を引数なしで実行する
  Then ヘルプメッセージが表示される
  And エラーメッセージは表示されない
```

## 受け入れ基準
- [ ] 引数なし実行時にTUIが自動起動する
- [ ] 明示的オプション指定時（--help等）は従来動作を維持
- [ ] パイプライン入力時は従来の変換モードを維持
- [ ] TUI起動失敗時は適切にヘルプにフォールバック
- [ ] 後方互換性が完全に保たれている
- [ ] 起動時間が2秒以内である

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- 引数なし実行→TUI起動の完全フロー
- 各種オプション指定時の動作確認
- パイプライン処理の動作確認

統合テスト:
- デフォルト動作判定ロジックテスト
- TUI起動条件分岐テスト
- フォールバック機能テスト

単体テスト:
- shouldStartTUI()関数の判定ロジック
- 引数解析とモード決定
- 条件分岐の境界値テスト
```

## 実装アプローチ
- **Outside-In**: E2E実行テストから実装開始
- **Red-Green-Refactor**: TDDサイクルで段階的実装
- **段階的移行**: 既存動作保持→新機能追加→最適化

## 技術仕様

### アーキテクチャ設計
既存のmain関数を拡張し、デフォルト動作判定機能を追加：

```go
// 実装イメージ
func shouldStartTUI(args []string) bool {
    // 引数が実行ファイル名のみ
    if len(args) != 1 {
        return false
    }

    // 標準入力にデータがない（パイプライン以外）
    stat, _ := os.Stdin.Stat()
    if (stat.Mode() & os.ModeCharDevice) == 0 {
        return false // パイプライン入力がある
    }

    return true
}

func runMainLogic() {
    // 引数解析前の判定
    if shouldStartTUI(os.Args) {
        runTUIMode()
    } else {
        runTraditionalMode()
    }
}
```

### 判定ロジック
1. **引数チェック**: `len(os.Args) == 1`（実行ファイル名のみ）
2. **標準入力チェック**: パイプライン入力の有無確認
3. **TUI利用可能性**: ターミナル環境の確認

### フォールバック戦略
- TUI起動失敗時はヘルプメッセージ表示
- エラーメッセージは表示せず、ユーザビリティ重視
- 既存の`printHelpMessage()`関数を活用

## 依存関係
- **前提PBI**: PBI-024（CLI サブコマンド拡張）、PBI-025（標準入力タイムアウト）完了済み
- **関連PBI**: 既存TUI機能（サンドボックス、ファイルセレクター）
- **外部依存**: なし（既存機能の組み合わせ）

## 見積もり
**2ストーリーポイント**（1-2日）
- **判定ロジック実装**: 2時間
- **フォールバック機能**: 1時間
- **E2Eテスト実装**: 3時間
- **統合・単体テスト**: 2時間
- **ドキュメント更新**: 1時間

## 技術的考慮事項

### パフォーマンス
- **TUI起動時間**: 2秒以内（既存TUI機能と同等）
- **判定処理**: 1ms以内（軽微な条件チェックのみ）
- **メモリ使用量**: 追加の常駐メモリなし

### セキュリティ
- **引数インジェクション**: 引数解析前の安全な判定
- **権限エスカレーション**: 追加権限不要
- **情報漏洩**: 判定ロジックに機密情報なし

### テスタビリティ
- **モック化**: `os.Args`、`os.Stdin.Stat()`のテスト対応
- **自動化**: CI/CDでのE2Eテスト実行
- **境界値**: 引数数・標準入力状態の組み合わせテスト

### 後方互換性
- **既存オプション**: 全て動作保持
- **パイプライン**: 従来通り変換処理実行
- **環境依存**: プラットフォーム別動作確認

## Definition of Done
- [ ] 4つのBDD受け入れシナリオが全て通る
- [ ] E2E/統合/単体テストが全て通る（テストカバレッジ90%以上）
- [ ] 既存機能への回帰がない（make test成功）
- [ ] パフォーマンス要件クリア（起動2秒以内）
- [ ] 後方互換性テスト通過
- [ ] クロスプラットフォーム動作確認（Windows/macOS/Linux）
- [ ] コードレビュー完了
- [ ] リファクタリング完了（技術的負債なし）
- [ ] ドキュメント更新（README.md使用例、CHANGELOG.md）

## 実装予定ファイル
- `cmd/usacloud-update/main.go` - デフォルト動作判定ロジック追加
- `cmd/usacloud-update/tui_default_e2e_test.go` - BDD E2Eテスト（新規作成）

## 開発プロセス（BDD×TDD統合）
1. **BDDシナリオ確認**: ステークホルダーとユーザー行動の合意
2. **E2Eテスト実装**: CLI実行→TUI起動の自動テスト
3. **Outside-In TDD**: 外側（CLI）から内側（判定ロジック）実装
4. **継続的リファクタリング**: 各グリーン後の品質向上
5. **シナリオ検証**: 実際のユーザー操作での最終確認

## 品質保証メトリクス
- **ビヘイビアカバレッジ**: 4/4シナリオ実装
- **テストピラミッド比率**: E2E:統合:単体 = 4:3:6
- **起動時間**: ≤2秒（既存TUI機能と同等）
- **互換性**: 既存全機能100%動作保持

---

**作成日**: 2025-09-17
**手法**: ryuzee × BDD × t_wada統合メソッド
**ステータス**: 📋 **Ready** - 実装準備完了