# PBI-031: 設定ファイルパス管理の統一

## ユーザーストーリー
開発者として、設定ファイルパス取得を一元管理したい、なぜなら環境変数やデフォルトパスの処理が重複しているから

## ビジネス価値
- **一貫性確保**: 全モジュールで同じ設定ファイルパスロジック
- **保守性向上**: パス取得ロジックの変更時に1箇所の修正で対応
- **設定管理統一**: 環境変数とデフォルトパスの統一的処理

## BDD受け入れシナリオ

```gherkin
Scenario: デフォルト設定ファイルパス取得
  Given 環境変数USACLOUD_UPDATE_CONFIG_DIRが設定されていない
  When アプリケーションが設定ファイルパスを取得する
  Then "~/.config/usacloud-update/usacloud-update.conf"が返される
  And ホームディレクトリが正しく解決される

Scenario: カスタム設定ディレクトリの使用
  Given 環境変数USACLOUD_UPDATE_CONFIG_DIR="/custom/config"が設定されている
  When アプリケーションが設定ファイルパスを取得する
  Then "/custom/config/.config/usacloud-update/usacloud-update.conf"が返される

Scenario: 設定ディレクトリの自動作成
  Given 設定ディレクトリが存在しない
  When アプリケーションが設定ファイルを作成しようとする
  Then ディレクトリが自動的に作成される
  And 適切な権限（700）が設定される

Scenario: 権限エラー時の適切な処理
  Given ホームディレクトリの取得に失敗する
  When アプリケーションが設定ファイルパスを取得する
  Then 適切なエラーメッセージが返される
```

## 受け入れ基準
- [ ] `internal/cli/config/paths.go`パッケージが作成されている
- [ ] `GetConfigFilePath() (string, error)`関数が実装されている
- [ ] `EnsureConfigDirectory(path string) error`関数が実装されている
- [ ] 環境変数`USACLOUD_UPDATE_CONFIG_DIR`の処理が統一されている
- [ ] デフォルトパス`~/.config/usacloud-update/usacloud-update.conf`が使用される
- [ ] 既存のgetConfigFilePath関数が置き換えられている
- [ ] ディレクトリ権限が700に設定される
- [ ] 既存のテストが全て通る

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- 設定ファイル作成・読み込みのCLI実行テスト
- 環境変数設定によるパス変更テスト

統合テスト:
- パス取得とディレクトリ作成の組み合わせテスト
- 権限設定とファイルアクセステスト

単体テスト:
- 環境変数解決テスト
- ホームディレクトリ解決テスト
- パス結合処理テスト
- エラーハンドリングテスト
```

## 実装アプローチ
- **Outside-In**: 設定ファイル使用からパス取得まで
- **Red-Green-Refactor**: 既存設定動作を保持
- **段階的移行**: パス取得→ディレクトリ作成→権限設定

## 見積もり
1ストーリーポイント

## 技術的考慮事項
- **依存関係**: 標準ライブラリのみ（os, path/filepath）
- **クロスプラットフォーム**: Windows/macOS/Linux対応
- **セキュリティ**: ディレクトリ権限700による保護
- **パフォーマンス**: ファイルシステムアクセス最小化

## Definition of Done
- [ ] 受け入れシナリオが全て通る
- [ ] 既存テストが全て通る（`make test`）
- [ ] 設定ファイルパスの動作に変更がない
- [ ] 全プラットフォームで動作確認済み
- [ ] コードレビュー完了
- [ ] リファクタリング完了（重複削除）
- [ ] セキュリティ検査通過

## 実装詳細
1. `internal/cli/config/`ディレクトリ作成
2. `paths.go`ファイル作成
3. `GetConfigFilePath`関数実装
4. `EnsureConfigDirectory`関数実装
5. 環境変数処理の統一
6. 既存のgetConfigFilePath関数を置き換え
7. テスト実行で動作確認

## パス管理機能一覧
- **環境変数処理**: `USACLOUD_UPDATE_CONFIG_DIR`による設定
- **デフォルトパス**: `~/.config/usacloud-update/usacloud-update.conf`
- **ディレクトリ作成**: 存在しない場合の自動作成
- **権限設定**: セキュリティ保護のための700権限
- **エラーハンドリング**: ホームディレクトリ取得失敗時の対処
- **クロスプラットフォーム**: OS固有のパス処理

## セキュリティ考慮事項
- **ディレクトリ権限**: 700（所有者のみアクセス可能）
- **ファイル権限**: 600（設定ファイル保護）
- **パストラバーサル**: 相対パス攻撃の防止
- **環境変数検証**: 不正な値の検証

## 関連PBI
- PBI-030: ファイルI/O処理の共通化（設定ファイル読み書き）
- PBI-029: エラーメッセージフォーマットの統一（パスエラー処理）