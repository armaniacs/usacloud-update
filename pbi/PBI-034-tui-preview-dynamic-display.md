# PBI-034: TUIプレビューペイン動的表示最適化

## ユーザーストーリー
**CLIユーザー**として、**TUIファイルセレクターのプレビューペインで利用可能なスペースを最大限活用した表示**がほしい、なぜなら**より多くのファイル内容を一度に確認してファイル選択の効率を向上させたい**から

## ビジネス価値
- **効率向上**: ファイル内容確認のためのスクロール操作を50%削減
- **UX改善**: 表示スペースの有効活用による視認性向上
- **生産性向上**: ファイル選択判断の高速化（推定30%向上）

## BDD受け入れシナリオ

```gherkin
Feature: TUIプレビューペイン動的表示最適化
  CLIユーザーとして
  プレビューペインで利用可能なスペースを最大限活用したい
  なぜならより多くのファイル内容を確認したいから

Scenario: 大きなウィンドウでの表示最適化
  Given ターミナルウィンドウの高さが50行である
  And プレビューペインの表示領域が40行分ある
  When ユーザーが100行のファイルを選択する
  Then プレビューペインに30行以上のファイル内容が表示される
  And 不要な余白なくコンテンツが表示される

Scenario: 小さなウィンドウでの最小表示保証
  Given ターミナルウィンドウの高さが20行である
  And プレビューペインの表示領域が10行分ある
  When ユーザーがファイルを選択する
  Then 最低10行のプレビューが表示される
  And ヘッダー情報が適切に表示される

Scenario: ウィンドウサイズ変更への追従
  Given プレビューペインが表示されている
  When ユーザーがターミナルウィンドウのサイズを変更する
  Then プレビューの表示行数が新しいサイズに応じて調整される
  And truncatedメッセージが適切に表示/非表示される
```

## 受け入れ基準
- [ ] プレビューペインの実際の高さに基づいて表示行数が動的に計算される
- [ ] 最小10行、最大100行の範囲で表示行数が調整される
- [ ] ヘッダー情報（ファイル名、パス、サイズ等）の行数が考慮される
- [ ] truncatedメッセージは実際にファイル内容が省略された場合のみ表示される
- [ ] ウィンドウリサイズ時に表示が自動更新される
- [ ] パフォーマンスへの影響が5ms以内である

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- 異なるウィンドウサイズでのTUI起動と表示確認
- ファイル選択時のプレビュー表示行数検証

統合テスト:
- GetRect()による高さ取得と行数計算の検証
- Preview()関数への動的パラメータ渡しテスト
- truncated表示条件の境界値テスト

単体テスト:
- 表示可能行数計算ロジックのテスト
- ヘッダー行数カウントのテスト
- 最小/最大行数の境界値テスト
```

## 実装アプローチ
- **Outside-In**: E2Eテストでウィンドウサイズ別表示確認から開始
- **Red-Green-Refactor**: 固定値を動的計算に段階的に置き換え
- **リファクタリング**: マジックナンバーの定数化、計算ロジックの抽出

## 技術仕様

### 実装変更点
1. **動的高さ取得**
   ```go
   _, _, _, height := fs.previewPane.GetRect()
   ```

2. **表示可能行数計算**
   ```go
   const (
       MinPreviewLines = 10
       MaxPreviewLines = 100
       HeaderLines = 10
       MarginLines = 2
   )

   availableLines := height - HeaderLines - MarginLines
   if availableLines < MinPreviewLines {
       availableLines = MinPreviewLines
   }
   if availableLines > MaxPreviewLines {
       availableLines = MaxPreviewLines
   }
   ```

3. **truncated表示条件改善**
   ```go
   // ファイル全体の行数を取得
   totalLines := len(strings.Split(fileContent, "\n"))

   // 実際に省略された場合のみ表示
   if len(preview) >= availableLines && availableLines < totalLines {
       content.WriteString("[gray]... (truncated)[white]\n")
   }
   ```

## 見積もり
**1ストーリーポイント**（0.5-1日）
- 動的高さ計算実装: 2時間
- テスト実装: 2時間
- リファクタリング: 1時間

## 技術的考慮事項

### パフォーマンス
- GetRect()呼び出しのキャッシュ検討
- ファイル読み込みの最適化（必要行数のみ）

### テスタビリティ
- GetRect()のモック化対応
- ウィンドウサイズのテスト環境制御

### エッジケース
- 極端に小さい/大きいウィンドウサイズ
- マルチバイト文字を含むファイル
- バイナリファイルの表示

## Definition of Done
- [ ] BDD受け入れシナリオが全て通る
- [ ] E2E/統合/単体テストが全て通る
- [ ] 既存機能への回帰がない
- [ ] パフォーマンス要件クリア（5ms以内）
- [ ] コードレビュー完了
- [ ] リファクタリング完了（マジックナンバー排除）

## 実装予定ファイル
- `internal/tui/file_selector.go` - updatePreview関数の修正
- `internal/tui/file_selector_test.go` - 動的表示のテスト追加

## 開発プロセス（BDD×TDD統合）
1. **BDDシナリオ確認**: ウィンドウサイズ別の表示要件確認
2. **E2Eテスト実装**: 実際のTUI起動での表示検証
3. **Outside-In TDD**: プレビュー表示から内部計算ロジックへ
4. **継続的リファクタリング**: 定数抽出、関数分離
5. **シナリオ検証**: 実際の使用感での最終確認

## 品質保証メトリクス
- **ビヘイビアカバレッジ**: 3/3シナリオ実装
- **テストピラミッド比率**: E2E:統合:単体 = 2:3:5
- **表示効率**: 利用可能スペースの90%以上活用

---

**作成日**: 2025-09-18
**手法**: ryuzee × BDD × t_wada統合メソッド
**ステータス**: 📋 **Ready** - 実装準備完了