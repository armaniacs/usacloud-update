# PBI-030: ファイルI/O処理の共通化

## ユーザーストーリー
開発者として、ファイル処理ロジックを共通化したい、なぜならバイナリファイル検出やエラーハンドリングが重複しているから

## ビジネス価値
- **保守性向上**: ファイル処理の変更時に影響範囲を限定
- **品質向上**: バイナリファイル検出ロジックの統一による信頼性確保
- **開発効率**: 新しいファイル処理機能追加時の工数削減

## BDD受け入れシナリオ

```gherkin
Scenario: バイナリファイル検出の統一
  Given バイナリファイル"binary.dat"が存在する
  When ユーザーが"usacloud-update --in binary.dat"を実行する
  Then "バイナリファイルは処理できません"エラーが表示される
  And 処理が中断される
  And 終了コード1で終了する

Scenario: 通常テキストファイルの正常読み込み
  Given テキストファイル"script.sh"が存在する
  When ユーザーが"usacloud-update --in script.sh"を実行する
  Then ファイルが正常に読み込まれる
  And バイナリエラーが発生しない

Scenario: 大きなファイルの読み込み処理
  Given 1MB以上のテキストファイル"large.sh"が存在する
  When ユーザーが"usacloud-update --in large.sh"を実行する
  Then メモリ効率的に読み込まれる
  And バッファサイズ1MBで処理される

Scenario: 出力ファイル書き込み権限エラー
  Given 書き込み権限のないディレクトリ"/root/output.sh"
  When ユーザーが"usacloud-update --out /root/output.sh"を実行する
  Then "出力ファイル書き込み失敗: 権限が不足しています"エラーが表示される
```

## 受け入れ基準
- [ ] `internal/cli/io/file.go`パッケージが作成されている
- [ ] `ReadInputFile(path string) (io.Reader, error)`関数が実装されている
- [ ] `WriteOutputFile(path string, content string) error`関数が実装されている
- [ ] `DetectBinaryContent(reader io.Reader) error`関数が実装されている
- [ ] バイナリファイル検出が512バイトのプリフィックスチェックで動作する
- [ ] 既存のファイル読み書き箇所が共通関数に置き換えられている
- [ ] 1MBバッファサイズが適用されている
- [ ] 既存のテストが全て通る

## t_wadaスタイル テスト戦略

```
E2Eテスト:
- 各種ファイルタイプでのCLI実行テスト
- 権限エラー・存在しないファイルテスト

統合テスト:
- ファイル読み書き関数の組み合わせテスト
- エラーハンドリング統合テスト

単体テスト:
- バイナリ検出ロジックテスト（nullバイト含有）
- ファイル権限テスト
- バッファサイズ処理テスト
- パス解決テスト
```

## 実装アプローチ
- **Outside-In**: CLI実行時のファイル処理から開始
- **Red-Green-Refactor**: 既存動作を保持しながら共通化
- **段階的移行**: 読み込み→書き込み→バイナリ検出の順

## 見積もり
3ストーリーポイント

## 技術的考慮事項
- **依存関係**: 標準ライブラリのみ（io, os, bufio）
- **テスタビリティ**: io.Readerインターフェースによる抽象化
- **パフォーマンス**: 1MBバッファでメモリ効率化
- **セキュリティ**: ファイルパス検証とサニタイズ

## Definition of Done
- [ ] 受け入れシナリオが全て通る
- [ ] 既存テストが全て通る（`make test`）
- [ ] ファイル処理の動作に変更がない
- [ ] メモリ使用量が改善または維持されている
- [ ] コードレビュー完了
- [ ] リファクタリング完了（重複削除）
- [ ] パフォーマンステスト通過

## 実装詳細
1. `internal/cli/io/`ディレクトリ作成
2. `file.go`ファイル作成
3. `FileReader`構造体定義（設定保持）
4. `ReadInputFile`関数実装（バイナリ検出含む）
5. `WriteOutputFile`関数実装（権限チェック含む）
6. 既存のファイル処理箇所を置き換え
7. テスト実行で動作確認

## ファイル処理機能一覧
- **標準入力対応**: `-`指定時のstdin読み込み
- **標準出力対応**: `-`指定時のstdout書き込み
- **バイナリ検出**: 512バイトスキャンによるnullバイト検出
- **権限チェック**: 読み書き権限の事前確認
- **エラー分類**: ファイル種別に応じたエラータイプ
- **バッファ管理**: 1MBバッファによる効率的処理

## 関連PBI
- PBI-029: エラーメッセージフォーマットの統一（エラー処理）
- PBI-031: 設定ファイルパス管理の統一（設定ファイル読み込み）