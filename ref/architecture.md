# アーキテクチャ概要

## プロジェクト構造（v1.9.0対応）

```
usacloud-update/
├── cmd/usacloud-update/     # CLI アプリケーション エントリーポイント
├── internal/
│   ├── transform/          # コア変換ロジック（v1.0-v1.1互換性）
│   ├── config/            # 設定ファイル管理システム（v1.9.0）
│   ├── sandbox/           # Sakura Cloud サンドボックス実行機能
│   ├── tui/              # ターミナルUI（tview based）
│   ├── bdd/              # BDD テスト（Godog integration）
│   └── scanner/          # ディレクトリスキャン・ファイル検出
├── testdata/              # テストデータ（サンプル入力と期待出力）
├── features/              # BDD テスト仕様（Gherkin記法）
├── ref/                   # プロジェクト参考資料
└── usacloud-update.conf.sample  # 設定ファイルサンプル
```

## コンポーネント設計

### 1. CLI レイヤー (`cmd/usacloud-update/main.go`) - v1.9.0拡張

**責務**: マルチモード対応のユーザーインターフェース制御

#### **従来の変換モード** (`runTraditionalMode()`)
- コマンドライン引数のパース (`--in`, `--out`, `--stats`)
- 標準入力/ファイル入力の抽象化
- 変換統計の色付き出力
- 生成ヘッダーの自動付与

#### **サンドボックスモード** (`runSandboxMode()`) ✨**v1.9.0新機能**
- サンドボックス設定の読み込み・検証
- ファイルセレクタTUIによる自動ファイル検出
- インタラクティブ/バッチ実行モードの切り替え
- マルチファイル一括処理対応

**主要な処理フロー**:
1. **モード判定**: `--sandbox` フラグによる動作分岐
2. **設定管理**: INI形式設定ファイル + 環境変数のハイブリッド対応
3. **入力ソース**: stdin/ファイル指定/ディレクトリスキャンの3パターン
4. **実行モード**: インタラクティブTUI/バッチ/ドライランの選択
5. **結果出力**: 変換のみ/実行結果の統合出力

### 2. 変換エンジン (`internal/transform/engine.go`) - コア機能

**責務**: ルールベースの変換システムの中核制御

**主要構造体**:
- `Engine`: ルール群を保持し、順次適用を管理
- `Result`: 変換結果と変更履歴を格納
- `Change`: 個別の変換記録 (ルール名、変更前後)

**処理の特徴**:

### 3. 設定管理 (`internal/config/`) ✨**v1.9.0新機能**

**責務**: INI形式設定ファイルと環境変数によるハイブリッド設定管理

#### **ファイル構成**:
- `file.go`: INI形式設定ファイルの読み書き
- `interactive.go`: 対話的設定ファイル作成
- `env.go`: 環境変数+設定ファイル統合読み込み

#### **設定ファイル仕様**:
```ini
[sakura-cloud]
access_token = your-access-token
access_token_secret = your-secret
zone = tk1v
api_endpoint = https://secure.sakura.ad.jp/cloud/zone/tk1v/api/cloud/1.1/

[sandbox]
enabled = true
debug = false
dry_run = false
interactive = true
timeout = 30
```

#### **設定ディレクトリ**:
- **デフォルト**: `~/.config/usacloud-update/`
- **カスタマイズ**: `USACLOUD_UPDATE_CONFIG_DIR` 環境変数
- **XDG準拠**: Linux標準ディレクトリ構造に対応

### 4. サンドボックス実行 (`internal/sandbox/`) ✨**v1.9.0新機能**

**責務**: Sakura Cloud tk1vゾーンでの安全なコマンド実行

#### **主要コンポーネント**:
- `executor.go`: usacloudコマンドの実行制御
- `executor_test.go`: サンドボックス実行のテスト

#### **安全機能**:
- **強制ゾーン**: 全コマンドに `--zone=tk1v` を自動付与
- **危険操作禁止**: `delete`, `shutdown`, `reset` 等をブロック
- **タイムアウト制御**: 30秒でコマンド実行を強制終了
- **コマンド検証**: usacloud以外のコマンドを実行拒否

### 5. ターミナルUI (`internal/tui/`) ✨**v1.9.0新機能**

**責務**: tviewライブラリベースのインタラクティブUI

#### **コンポーネント**:
- `app.go`: メインTUIアプリケーション + **ヘルプ切り替え機能**
- `file_selector.go`: ファイル選択UI + **ヘルプ切り替え機能**

#### **主要機能**:
- **コマンド一覧表示**: 変換されたコマンドの選択可能リスト
- **実行結果表示**: リアルタイムな実行結果とステータス
- **ヘルプパネル**: `?`キーによる表示/非表示切り替え ✨**PBI-1完了**
- **キーボードショートカット**: 直感的な操作インターフェース

### 6. BDD テスト (`internal/bdd/`) ✨**v1.9.0新機能**

**責務**: Gherkin記法による行動駆動開発テスト

#### **ファイル構成**:
- `steps.go`: 7つの完全実装済みBDDステップ関数 ✨**PBI-2完了**
- `main_test.go`: Godogテストランナーの統合

#### **テスト対象範囲**:
- TUIインタラクティブ機能の動作検証
- サンドボックス実行の結果表示確認
- 設定エラー時のガイダンス検証
- 変換+実行の統合フロー確認

### 7. ディレクトリスキャナ (`internal/scanner/`) ✨**v1.9.0新機能**

**責務**: usacloudコマンドを含むスクリプトファイルの自動検出

#### **機能**:
- **深度制御可能なディレクトリ探索**
- **usacloudコマンド検出**: ファイル内容を解析して適切なファイルを識別
- **ファイル情報付与**: サイズ、更新日時、相対パス等のメタデータ
- **除外パターン**: `.tmp`, `.bak`, `.log` 等の不要ファイル自動除外
- コメント行と空行のスキップ
- ルールの順次適用（チェーン・オブ・レスポンシビリティ）
- 詳細な変更追跡とメタデータ収集

### 3. ルールシステム (`internal/transform/rules.go`)

**責務**: 変換ルールの具象実装

**`simpleRule` の構成要素**:
- `re`: 正規表現パターン
- `repl`: マッチ結果からの置換テキスト生成関数
- `reason`: 変更理由の説明
- `url`: 公式ドキュメントへの参照

**自動コメント機能**:
- 形式: `# usacloud-update: 理由 (URL)`
- 重複コメント防止機能
- 変更箇所の詳細なフラグメント追跡

### 4. ルール定義 (`internal/transform/ruledefs.go`)

**責務**: usacloud v0.x → v1.1 移行の具体的なドメインロジック

**変換ルールカテゴリ**:
1. 出力形式変換: `csv/tsv` → `json`
2. セレクタ移行: `--selector` → コマンド引数
3. リソース名変更: 3つの主要リソース名の統一
4. エイリアス整理: `product-*` → `*-plan`
5. 廃止コマンド: コメントアウト処理
6. 構文正規化: 空白文字の統一

## 設計パターン

### Strategy パターン
- `Rule` インターフェースにより変換戦略を交換可能
- 新しい変換ルールの追加が容易

### Chain of Responsibility パターン
- ルールの順次適用により複合的な変換を実現
- 各ルールは独立して動作

### Template Method パターン
- `simpleRule` が共通の変換処理テンプレートを提供
- 個別のルールは正規表現と置換ロジックのみ定義

## データフロー

```
入力行
  ↓
Engine.Apply()
  ↓
各Rule.Apply() (順次実行)
  ↓
Result (変換済み行 + 変更履歴)
  ↓
CLI出力 (統計情報 + 生成ファイル)
```

## 拡張ポイント

### 新しい変換ルールの追加
1. `ruledefs.go` の `DefaultRules()` に `mk()` 呼び出しを追加
2. 正規表現パターンと置換関数を定義
3. 公式ドキュメントのURLを指定

### 複雑な変換ロジック
- カスタム `Rule` 実装で `simpleRule` を超える処理が可能
- 複数行にまたがる変換や文脈依存の処理に対応

### テストの拡張
- `testdata/` に新しいサンプルファイルを追加
- Golden ファイルテストで回帰を防止