# アーキテクチャ概要

## プロジェクト構造

```
usacloud-update/
├── cmd/usacloud-update/     # CLI アプリケーション エントリーポイント
├── internal/transform/     # コア変換ロジック
├── testdata/              # テストデータ（サンプル入力と期待出力）
└── ref/                   # プロジェクト参考資料
```

## コンポーネント設計

### 1. CLI レイヤー (`cmd/usacloud-update/main.go`)

**責務**: ユーザーインターフェースとファイル入出力の制御

- コマンドライン引数のパース (`--in`, `--out`, `--stats`)
- 標準入力/ファイル入力の抽象化
- 変換統計の色付き出力
- 生成ヘッダーの自動付与

**主要な処理フロー**:
1. 入力ソース設定 (stdin または ファイル)
2. 変換エンジンの初期化
3. 行単位での変換処理
4. 変更統計の stderr への出力
5. 結果の出力 (stdout または ファイル)

### 2. 変換エンジン (`internal/transform/engine.go`)

**責務**: ルールベースの変換システムの中核制御

**主要構造体**:
- `Engine`: ルール群を保持し、順次適用を管理
- `Result`: 変換結果と変更履歴を格納
- `Change`: 個別の変換記録 (ルール名、変更前後)

**処理の特徴**:
- コメント行と空行のスキップ
- ルールの順次適用（チェーン・オブ・レスポンシビリティ）
- 詳細な変更追跡とメタデータ収集

### 3. ルールシステム (`internal/transform/rules.go`)

**責務**: 変換ルールの具象実装

**`simpleRule` の構成要素**:
- `re`: 正規表現パターン
- `repl`: マッチ結果からの置換テキスト生成関数
- `reason`: 変更理由の説明
- `url`: 公式ドキュメントへの参照

**自動コメント機能**:
- 形式: `# usacloud-update: 理由 (URL)`
- 重複コメント防止機能
- 変更箇所の詳細なフラグメント追跡

### 4. ルール定義 (`internal/transform/ruledefs.go`)

**責務**: usacloud v0.x → v1.1 移行の具体的なドメインロジック

**変換ルールカテゴリ**:
1. 出力形式変換: `csv/tsv` → `json`
2. セレクタ移行: `--selector` → コマンド引数
3. リソース名変更: 3つの主要リソース名の統一
4. エイリアス整理: `product-*` → `*-plan`
5. 廃止コマンド: コメントアウト処理
6. 構文正規化: 空白文字の統一

## 設計パターン

### Strategy パターン
- `Rule` インターフェースにより変換戦略を交換可能
- 新しい変換ルールの追加が容易

### Chain of Responsibility パターン
- ルールの順次適用により複合的な変換を実現
- 各ルールは独立して動作

### Template Method パターン
- `simpleRule` が共通の変換処理テンプレートを提供
- 個別のルールは正規表現と置換ロジックのみ定義

## データフロー

```
入力行
  ↓
Engine.Apply()
  ↓
各Rule.Apply() (順次実行)
  ↓
Result (変換済み行 + 変更履歴)
  ↓
CLI出力 (統計情報 + 生成ファイル)
```

## 拡張ポイント

### 新しい変換ルールの追加
1. `ruledefs.go` の `DefaultRules()` に `mk()` 呼び出しを追加
2. 正規表現パターンと置換関数を定義
3. 公式ドキュメントのURLを指定

### 複雑な変換ロジック
- カスタム `Rule` 実装で `simpleRule` を超える処理が可能
- 複数行にまたがる変換や文脈依存の処理に対応

### テストの拡張
- `testdata/` に新しいサンプルファイルを追加
- Golden ファイルテストで回帰を防止